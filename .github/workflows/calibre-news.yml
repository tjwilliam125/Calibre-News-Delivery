name: Daily News to Drive

# TRIGGERS
on:
  workflow_dispatch:
  schedule:
    # 6:00 AM CDT (UTC-5) = 11:00 UTC
    - cron: '0 11 * * *'

jobs:
  fetch-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # NEW STEP: Fixes the "missing system library" error
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libegl1 libopengl0 libxcb-cursor0

    - name: Install Calibre
      run: |
        sudo -v && wget -nv -O- https://download.calibre-ebook.com/linux-installer.sh | sudo sh /dev/stdin

    # STEP 3: Fetch News
    - name: Fetch and Convert News
      run: |
        ebook-convert "Financial Times.recipe" "FT.epub" --output-profile=tablet || true
        ebook-convert "The Economist.recipe" "Economist.epub" --output-profile=tablet || true
        ebook-convert "The Atlantic.recipe" "Atlantic.epub" --output-profile=tablet || true
        ebook-convert "The Guardian and Observer.recipe" "Guardian.epub" --output-profile=tablet || true
        ebook-convert "The New Yorker.recipe" "NewYorker.epub" --output-profile=tablet --username="${{ secrets.NY_USERNAME }}" --password="${{ secrets.NY_PASSWORD }}" || true

    # STEP 4: Upload All Epubs
    - name: Upload to Google Drive
      uses: adityak74/google-drive-upload-git-action@main
      with:
        credentials: ${{ secrets.DRIVE_CREDENTIALS }}
        filename: "*.epub"
        folderId: ${{ secrets.DRIVE_FOLDER_ID }}
        overwrite: "true"
