name: Dropbox News

on:
  workflow_dispatch:
  schedule:
    - cron: '0 11 * * *' # Runs at 11:00 UTC (6:00 AM CDT)

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install System Libs
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1 libopengl0 libxcb-cursor0 python3-pip

      - name: Install Python Libs
        run: pip3 install requests

      - name: Install Calibre
        run: |
          sudo -v && wget -nv -O- https://download.calibre-ebook.com/linux-installer.sh | sudo sh /dev/stdin

      - name: Fetch News
        run: |
          # 1. Standard Recipes
          ebook-convert "Financial Times.recipe" "FT.epub" --output-profile=tablet || true
          ebook-convert "The Economist.recipe" "Economist.epub" --output-profile=tablet || true
          ebook-convert "The Atlantic.recipe" "Atlantic.epub" --output-profile=tablet || true
          ebook-convert "Ars Technica.recipe" "ArsTechnica.epub" --output-profile=tablet || true
          ebook-convert "Wired.recipe" "Wired.epub" --output-profile=tablet || true
          ebook-convert "Hacker News.recipe" "HackerNews.epub" --output-profile=tablet || true
          ebook-convert "Scientific American.recipe" "SciAm.epub" --output-profile=tablet || true
          ebook-convert "ProPublica.recipe" "ProPublica.epub" --output-profile=tablet || true

          # 2. Custom/Specific Recipes
          # Requires 'GuardianUS_RSS.recipe' file in your repo
          ebook-convert "GuardianUS_RSS.recipe" "GuardianUS.epub" --output-profile=tablet || true

          # New Yorker RSS (Print Edition is more stable)
          # Requires 'NewYorker_Custom.recipe' file in your repo
          ebook-convert "NewYorker_Custom.recipe" "NewYorker.epub" --output-profile=tablet || true

      - name: Upload to Dropbox (With Date Stamp)
        env:
          KEY: ${{ secrets.DROPBOX_APP_KEY }}
          SECRET: ${{ secrets.DROPBOX_APP_SECRET }}
          REFRESH: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
        run: |
          python3 -c "
          import os, sys, requests, glob, json
          from datetime import datetime
          
          # CONFIG
          KEY = os.environ['KEY']
          SECRET = os.environ['SECRET']
          REFRESH = os.environ['REFRESH']
          TODAY = datetime.utcnow().strftime('%Y-%m-%d') # e.g., 2025-12-22

          # 1. Refresh Token
          print('Refreshing Token...')
          res = requests.post('https://api.dropbox.com/oauth2/token', data={
              'grant_type': 'refresh_token', 
              'refresh_token': REFRESH,
              'client_id': KEY,
              'client_secret': SECRET
          })
          if res.status_code != 200:
              print('Token Error:', res.text)
              sys.exit(1)
          
          TOKEN = res.json()['access_token']
          HEADERS = {'Authorization': f'Bearer {TOKEN}', 'Content-Type': 'application/octet-stream'}
          
          # 2. Upload Files
          for fpath in glob.glob('*.epub'):
              # Rename: Economist.epub -> Economist_2025-12-22.epub
              base_name = os.path.splitext(fpath)[0]
              dated_name = f'{base_name}_{TODAY}.epub'
              
              print(f'Uploading {dated_name}...')
              with open(fpath, 'rb') as f:
                  data = f.read()
              
              args = {'path': f'/{dated_name}', 'mode': 'overwrite', 'mute': True}
              h = HEADERS.copy()
              h['Dropbox-API-Arg'] = json.dumps(args)
              
              requests.post('https://content.dropboxapi.com/2/files/upload', headers=h, data=data)

          # 3. Cleanup Old Files (Older than 7 days)
          print('Checking for old files...')
          list_h = {'Authorization': f'Bearer {TOKEN}', 'Content-Type': 'application/json'}
          lr = requests.post('https://api.dropboxapi.com/2/files/list_folder', headers=list_h, json={'path': ''})
          
          if lr.status_code == 200:
              now = datetime.utcnow()
              for entry in lr.json().get('entries', []):
                  if entry['.tag'] == 'file':
                      try:
                          ts = datetime.strptime(entry['server_modified'], '%Y-%m-%dT%H:%M:%SZ')
                          if (now - ts).days > 7:
                              print(f'Deleting {entry[\"name\"]}')
                              requests.post('https://api.dropboxapi.com/2/files/delete_v2', headers=list_h, json={'path': entry['path_lower']})
                      except:
                          pass
          "
